/* Write a CTE query to calculate for the total payments made by top 5 customers*/

/*Define the CTE*/
WITH top_5_customers AS
(
SELECT
  	CU.customer_id,
  	CONCAT(CU.first_name, ' ', CU.last_name) AS customer_name,
  	CO.country,
  	CI.city,
  	SUM(PY.amount) AS total_amount_paid
FROM customer CU
  	INNER JOIN payment PY ON CU.customer_id = PY.customer_id
  	INNER JOIN address A ON CU.address_id = A.address_id
  	INNER JOIN city CI ON A.city_id = CI.city_id
  	INNER JOIN country CO ON CI.country_id = CO.country_id
WHERE
  	CI.city IN ('Aurora', 'Atlixco', 'Xintai', 'Adoni','Dhule (Dhulia)', 
						'Kurashiki', 'Pingxiang', 'Sivas', 'Celaya', 'So Leopoldo')
GROUP BY CU.customer_id, customer_name, CO.country, CI.city
ORDER BY total_amount_paid DESC
LIMIT 5
)

/*Main query section, where CTE is referenced*/
SELECT
  	CO.country,
  	COUNT(DISTINCT CU.customer_id) AS all_customer_count,
  	COUNT(top_5_customers.customer_id) AS top_customer_count
FROM customer CU
  	INNER JOIN address A ON CU.address_id = A.address_id
  	INNER JOIN city CI ON A.city_id = CI.city_id
  	INNER JOIN country CO ON CI.country_id = CO.country_id
  	LEFT JOIN top_5_customers ON CU.customer_id = top_5_customers.customer_id
GROUP BY CO.country
ORDER BY top_customer_count DESC
LIMIT 10;
